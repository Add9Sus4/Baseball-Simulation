<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
<%= stylesheet_link_tag "jquery-ui.min", 'data-turbolinks-track' => true %>
<%= javascript_include_tag "jquery-ui.min", 'data-turbolinks-track' =>true %>
<%= javascript_include_tag 'bootstrap-sortable', 'data-turbolinks-track' => true %>
<%= javascript_include_tag 'moment.min', 'data-turbolinks-track' => true %>
<%= stylesheet_link_tag    'bootstrap-sortable', 'data-turbolinks-track' => true %>
<!-- <p id="notice"><%= notice %></p> -->

<h2>
<%= @team.city %>
<%= @team.name %>
</h2>

</br>

<p>
  <strong>League:</strong>
  <%= @team.league %>
</p>

<p>
  <strong>Division:</strong>
  <%= @team.division %>
</p>

<p>
  <strong>Stadium:</strong>
  <%= @team.stadium %>
</p>

<p>
  <strong>Capacity:</strong>
  <%= @team.capacity %>
</p>

</br>

<%= link_to 'Edit Team Info', edit_team_path(@team), method: :get %> |
<%= link_to 'Delete Team', @team, method: :delete, data: { confirm: 'Are you sure you want to delete the ' + @team.name + '?' } %> |
<%= link_to 'All Teams', teams_path, method: :get %> |
<%= link_to 'Back', 'javascript:history.go(-1);', method: :get %>


<p/>

<h3>Roster</h3>

<div id="roster_div">
  <table class="table_with_custom_border roster sortable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Age</th>
        <th>Height</th>
        <th>Weight</th>
        <th id="position_column_header" data-defaultsort="asc">Natural Position</th>
        <th>Salary</th>
      </tr>
    </thead>
    <tbody>
      <% @team.players.each do |player| %>
        <tr class="player_row">
          <td><%= link_to player.full_name, player, method: :get %></td>
          <td><%= player.age %></td>
          <td class="height"><%= player.height %></td>
          <td><%= player.weight %> lb.</td>
          <td class="position"><%= player.position %></td>
          <td class="salary"><%= player.salary %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<style>

.ui-sortable tr {
  cursor: move;
}

.dragging {
  background-color: #edf0f8;
  opacity: 0.5;
}

.ui-sortable-helper {
  background-color: #dae2f1;
  opacity: 1.0;
}

.bench {
  cursor: default !important;
}

</style>

<script>

$('.salary').each(function() {
  $(this).attr('data-value', salaryToInteger($(this).text()));
});

function salaryToInteger(salary) {
  var condensedSalary = salary.replace(/[$,.]/g,''); // Get rid of dollar signs and commas
  return parseInt(condensedSalary);
}

$(document).ready(function() {
  var fixHelperModified = function(e, tr) {
    var $originals = tr.children();
    var $helper = tr.clone();
    $helper.children().each(function(index) {
      $(this).width($originals.eq(index).width());
    });
    return $helper;
  };

  $(".lineup > tbody > tr").each(function() {
    var span = $(this).find("span");
    if (span.text().indexOf('BN') > -1) {
      $(this).addClass("bench");
    }
  });

  $(".roster tbody").sortable({
    helper: 'clone',
    delay: 150,
    tolerance: "pointer",
    cancel: ".bench",

    start: function(event, ui) {
      $(this).find("tr").toggleClass('dragging');

    },
    stop: function(event, ui) {
      $(this).find("tr").toggleClass('dragging');
    },
    // containment: "#roster_div",
  }).disableSelection();

  $(".lineup tbody").sortable({
    helper: 'clone',
    delay: 150,
    tolerance: "pointer",
    cancel: ".bench",

    start: function(event, ui) {
      $(this).find("tr").toggleClass('dragging');

    },
    stop: function(event, ui) {
      $('#lineup_changed').show();
      $(this).find("tr").toggleClass('dragging');
    },
    containment: "#view_lineup"
  }).disableSelection();

});
</script>


<style>

#lineup_changed {
  padding-top: 10px;
}

.lineup > thead > tr > th:nth-child(1) {
  width: 75px;
}

.lineup > thead > tr > th:nth-child(2) {
  width: 150px;
}

#lineup_bench > tbody > tr > td:nth-child(1) {
  width: 138px;
}

#lineup_bench > tbody > tr > td:nth-child(2) {
  width: 150px;
}
</style>


<h3>Lineup</h3>
<button id="edit_lineup_button" onClick="toggleLineupEdit()">Edit</button>
<div id="edit_lineup" style="display: none;">
  <%= render 'position_form' %>
</div>

<style>
.order {
  float: left;
}
</style>

<div id="view_lineup">
</br>
<table class="order table_with_custom_border table-condensed table-striped table-bordered">
  <thead>
    <tr>
      <th>
        Order
      </th>
    </tr>
  </thead>
  <tbody>
    <% for i in 1..9 do %>
    <tr>
      <td>
        <%= i %>
      </td>
    </tr>
    <% end %>
  </tbody>
</table>
<% @battingOrder = [Player.find(@team.lineup1),
                    Player.find(@team.lineup2),
                    Player.find(@team.lineup3),
                    Player.find(@team.lineup4),
                    Player.find(@team.lineup5),
                    Player.find(@team.lineup6),
                    Player.find(@team.lineup7),
                    Player.find(@team.lineup8),
                    Player.find(@team.lineup9)]%>
<table class="lineup table_with_custom_border table-condensed table-striped table-bordered">
  <thead>
    <tr>
      <th>Position</th>
      <th>Player</th>
    </tr>
  </thead>
  <tbody>
    <% for i in 0..8 do %>
      <tr>
        <td><%= @team.find_position(@battingOrder[i].id)%></td>
        <td><%= @battingOrder[i] %><span "hidden_id" hidden><%= @battingOrder[i].id %></span></td>
      </tr>
    <% end %>
  </tbody>
</table>

<table id="lineup_bench" class="table_with_custom_border table-condensed table-striped table-bordered">
  <tbody>
    <tr><td>Bench 1</td><td><%= Player.find(@team.bench1) %></td></tr>
    <tr><td>Bench 2</td><td><%= Player.find(@team.bench2) %></td></tr>
    <tr><td>Bench 3</td><td><%= Player.find(@team.bench3) %></td></tr>
    <tr><td>Bench 4</td><td><%= Player.find(@team.bench4) %></td></tr>
  </tbody>
</table>
</div>

<div id="lineup_changed" hidden>
  <button id="save_lineup_changes" onclick="saveLineupChanges()">Save Lineup Changes</button>
</div>

<script>

function saveLineupChanges() {
  player_ids = $.map($(".lineup tbody").find("tr"), function(element) {
    return $(element).find("td:nth-child(2) span").text();
  })

  $.ajax({
    url: window.location.href,
    type: 'PATCH',
    dataType: 'json',
    data: { "team": { "lineup1": player_ids[0],
                      "lineup2": player_ids[1],
                      "lineup3": player_ids[2],
                      "lineup4": player_ids[3],
                      "lineup5": player_ids[4],
                      "lineup6": player_ids[5],
                      "lineup7": player_ids[6],
                      "lineup8": player_ids[7],
                      "lineup9": player_ids[8]
                    }
          },
  });
  $("#lineup_changed").hide();
}

function toggleLineupEdit() {
  $("#edit_lineup").toggle();
  $("#view_lineup").toggle();
  $("#edit_lineup_button").toggle();
}

$('.position').each(function() {
  var positionSymbol = $(this).text();
  var position = '';
  switch (positionSymbol.toLowerCase()) {
    case 'p':
      $(this).attr('data-value',1);
      position = 'Pitcher';
      break;
    case 'c':
    $(this).attr('data-value',2);
      position = 'Catcher';
      break;
    case '1b':
      $(this).attr('data-value',3);
      position = 'First Base';
      break;
    case '2b':
      $(this).attr('data-value',4);
      position = 'Second Base';
      break;
    case '3b':
      $(this).attr('data-value',5);
      position = 'Third Base';
      break;
    case 'ss':
      $(this).attr('data-value',6);
      position = 'Shortstop';
      break;
    case 'lf':
      $(this).attr('data-value',7);
      position = 'Left Field';
      break;
    case 'cf':
      $(this).attr('data-value',8);
      position = 'Center Field';
      break;
    case 'rf':
      $(this).attr('data-value',9);
      position = 'Right Field';
      break;
  }
  $(this).text(position);
});

$('.height').each(function() {
  var height = $(this).text();
  var feet = Math.floor(Number(height)/12);
  var inches = Number(height) - feet*12;
  var text = $(this).text();
  $(this).text(feet + '\' ' + inches + '\"');
  $(this).attr('data-value', height);
});

$('.salary').each(function() {
  var item = $(this).text();
  var num = Number(item).toLocaleString('en');

  if(Number(item) < 0) {
    num = num.replace('-','');
    $(this).addClass('negMoney');
  } else {
    $(this).addClass('enMoney');
  }
  $(this).text(num);
});
</script>
